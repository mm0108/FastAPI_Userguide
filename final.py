import pandas as pd
from ortools.sat.python import cp_model
import time
import os

# --- 1. λ°μ΄ν„° λ¶λ¬μ¤κΈ° λ° μμ› μ •μ ---
print("CSV νμΌλ΅λ¶€ν„° λ°μ΄ν„°λ¥Ό λ¶λ¬μ¤κ³  μμ›μ„ μ •μν•κ³  μμµλ‹λ‹¤...")

νμΌ_κ²½λ΅ = 'courses_data.csv'

if not os.path.exists(νμΌ_κ²½λ΅):
    print(f"β μ¤λ¥: '{νμΌ_κ²½λ΅}' νμΌμ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤. νμΌ κ²½λ΅λ¥Ό ν™•μΈν•΄ μ£Όμ„Έμ”.")
    exit()

try:
    df_κµκ³Όλ© = pd.read_csv(νμΌ_κ²½λ΅)
    print("β… λ°μ΄ν„° λ¶λ¬μ¤κΈ° μ„±κ³µ.")
except Exception as e:
    print(f"β μ¤λ¥: λ°μ΄ν„° νμΌμ„ μ½λ” μ¤‘ λ¬Έμ κ°€ λ°μƒν–μµλ‹λ‹¤. ({e})")
    exit()

μ»¬λΌλ…_λ§¤ν•‘ = {
    'κµκ³Όλ©λ…': 'κµκ³Όλ©λ…',
    'μκ°•μΈμ›': 'μκ°•μΈμ›',
    'κ°•μΆλ€ν‘κµμ': 'κµμλ…',
    'κµκ³Όλ©ν•™μ ': 'ν•™μ ',
    'κ°•μμ ν•κµ¬λ¶„': 'κ°•μμ ν•'
}
df_κµκ³Όλ© = df_κµκ³Όλ©.rename(columns=μ»¬λΌλ…_λ§¤ν•‘)

κ°•μ_λ©λ΅ = []
for index, row in df_κµκ³Όλ©.iterrows():
    κ°•μμ‹κ°„ = int(row['ν•™μ '])
    κ°•μ_λ©λ΅.append({
        'κ°•μID': index,
        'κµκ³Όλ©λ…': row['κµκ³Όλ©λ…'],
        'κµμλ…': row['κµμλ…'],
        'μκ°•μΈμ›': row['μκ°•μΈμ›'],
        'κ°•μμ‹κ°„': κ°•μμ‹κ°„,
        'μ‹¤μµν•„μ”': 1 if row['κ°•μμ ν•'] == 'μ‹¤μµ' else 0
    })

κ°•μμ‹¤_λ©λ΅ = [
    {'μ΄λ¦„': '1215', 'μμ©μΈμ›': 40, 'μ ν•': 'μ‹¤μµμ‹¤'},
    {'μ΄λ¦„': '1216', 'μμ©μΈμ›': 40, 'μ ν•': 'μ‹¤μµμ‹¤'},
    {'μ΄λ¦„': '1217', 'μμ©μΈμ›': 40, 'μ ν•': 'μ‹¤μµμ‹¤'},
    {'μ΄λ¦„': '1418', 'μμ©μΈμ›': 40, 'μ ν•': 'μ‹¤μµμ‹¤'},
    {'μ΄λ¦„': 'μ„λ€κ°•μμ‹¤', 'μμ©μΈμ›': 60, 'μ ν•': 'μ‹¤μµμ‹¤'},
]
κ°•μμ‹¤_μ = len(κ°•μμ‹¤_λ©λ΅)
κ°•μμ‹¤_μ΄λ¦„_λ©λ΅ = [r['μ΄λ¦„'] for r in κ°•μμ‹¤_λ©λ΅]

μ”μΌ_μ = 5
μΌλ³„_μ‹κ°„_μ = 8
μ΄_μ‹κ°„_μ¬λ΅― = μ”μΌ_μ * μΌλ³„_μ‹κ°„_μ

# --- 2. CP-SAT λ¨λΈ κµ¬μ¶• ---
λ¨λΈ = cp_model.CpModel()
print("CP-SAT μ μ•½ λ§μ΅± λ¨λΈμ„ μƒμ„±ν•©λ‹λ‹¤...")

λ°°μ •_λ³€μ = {}
for κ°•μ in κ°•μ_λ©λ΅:
    κ°•μID = κ°•μ['κ°•μID']
    κ°•μμ‹κ°„ = κ°•μ['κ°•μμ‹κ°„']

    μ‹μ‘_μ‹κ°„ = λ¨λΈ.NewIntVar(0, μ΄_μ‹κ°„_μ¬λ΅― - κ°•μμ‹κ°„, f'μ‹μ‘_{κ°•μID}')
    μΆ…λ£_μ‹κ°„ = λ¨λΈ.NewIntVar(0, μ΄_μ‹κ°„_μ¬λ΅―, f'μΆ…λ£_{κ°•μID}')
    κ°•μμ‹¤_λ³€μ = λ¨λΈ.NewIntVar(0, κ°•μμ‹¤_μ - 1, f'κ°•μμ‹¤_{κ°•μID}')
    λ¨λΈ.Add(μ‹μ‘_μ‹κ°„ + κ°•μμ‹κ°„ == μΆ…λ£_μ‹κ°„)

    μΈν„°λ² = λ¨λΈ.NewIntervalVar(μ‹μ‘_μ‹κ°„, κ°•μμ‹κ°„, μΆ…λ£_μ‹κ°„, f'μΈν„°λ²_{κ°•μID}')
    λ°°μ •_λ³€μ[κ°•μID] = (μ‹μ‘_μ‹κ°„, κ°•μμ‹¤_λ³€μ, μΈν„°λ²)

# --- 3. ν•µμ‹¬ μ μ•½ μ΅°κ±΄ μ¶”κ°€ ---

# 3.1. κ°•μμ‹¤ μ¤‘λ³µ κΈμ§€
for κ°•μμ‹¤_μΈλ±μ¤ in range(κ°•μμ‹¤_μ):
    μΈν„°λ²_λ¦¬μ¤νΈ = []
    for κ°•μ in κ°•μ_λ©λ΅:
        κ°•μID = κ°•μ['κ°•μID']
        μ‹μ‘_μ‹κ°„, κ°•μμ‹¤_λ³€μ, _ = λ°°μ •_λ³€μ[κ°•μID]
        ν•΄λ‹Ή_κ°•μμ‹¤_μ—¬λ¶€ = λ¨λΈ.NewBoolVar(f'κ°•μ_{κ°•μID}_κ°•μμ‹¤_{κ°•μμ‹¤_μΈλ±μ¤}_μ—¬λ¶€')
        λ¨λΈ.Add(κ°•μμ‹¤_λ³€μ == κ°•μμ‹¤_μΈλ±μ¤).OnlyEnforceIf(ν•΄λ‹Ή_κ°•μμ‹¤_μ—¬λ¶€)
        λ¨λΈ.Add(κ°•μμ‹¤_λ³€μ != κ°•μμ‹¤_μΈλ±μ¤).OnlyEnforceIf(ν•΄λ‹Ή_κ°•μμ‹¤_μ—¬λ¶€.Not())
        μΈν„°λ²_μ„ νƒ = λ¨λΈ.NewOptionalIntervalVar(μ‹μ‘_μ‹κ°„, κ°•μ['κ°•μμ‹κ°„'],
                                                   μ‹μ‘_μ‹κ°„ + κ°•μ['κ°•μμ‹κ°„'], ν•΄λ‹Ή_κ°•μμ‹¤_μ—¬λ¶€,
                                                   f'μ„ νƒμ _μΈν„°λ²_{κ°•μID}_{κ°•μμ‹¤_μΈλ±μ¤}')
        μΈν„°λ²_λ¦¬μ¤νΈ.append(μΈν„°λ²_μ„ νƒ)
    λ¨λΈ.AddNoOverlap(μΈν„°λ²_λ¦¬μ¤νΈ)

# 3.2. κµμ μ¤‘λ³µ κΈμ§€
κµμ_λ©λ΅ = df_κµκ³Όλ©['κµμλ…'].unique()
for κµμ in κµμ_λ©λ΅:
    κµμ_κ°•μ_λ¦¬μ¤νΈ = [c for c in κ°•μ_λ©λ΅ if c['κµμλ…'] == κµμ]
    μΈν„°λ²_λ¦¬μ¤νΈ = [λ°°μ •_λ³€μ[c['κ°•μID']][2] for c in κµμ_κ°•μ_λ¦¬μ¤νΈ]
    λ¨λΈ.AddNoOverlap(μΈν„°λ²_λ¦¬μ¤νΈ)

# 3.3. μμ©μΈμ› λ° ν•λ£¨ μΆ…λ£ μ μ•½ (AddModuloEquality μ‚¬μ©)
for κ°•μ in κ°•μ_λ©λ΅:
    κ°•μID = κ°•μ['κ°•μID']
    μ‹μ‘_μ‹κ°„, κ°•μμ‹¤_λ³€μ, _ = λ°°μ •_λ³€μ[κ°•μID]

    # ν•λ£¨ λ‚΄ λλ‚λ„λ΅ modulo μ μ•½
    r = λ¨λΈ.NewIntVar(0, μΌλ³„_μ‹κ°„_μ - 1, f'mod_{κ°•μID}')
    λ¨λΈ.AddModuloEquality(r, μ‹μ‘_μ‹κ°„, μΌλ³„_μ‹κ°„_μ)
    λ¨λΈ.Add(r + κ°•μ['κ°•μμ‹κ°„'] <= μΌλ³„_μ‹κ°„_μ)

    # μμ©μΈμ› μ μ•½
    for idx, κ°•μμ‹¤ in enumerate(κ°•μμ‹¤_λ©λ΅):
        if κ°•μ['μκ°•μΈμ›'] > κ°•μμ‹¤['μμ©μΈμ›']:
            λ¨λΈ.Add(κ°•μμ‹¤_λ³€μ != idx)

# --- 4. λ¨λΈ ν’€κΈ° ---
print("\nλ¨λΈ ν•΄μ°ΎκΈ°λ¥Ό μ‹μ‘ν•©λ‹λ‹¤...")
ν•΄κ²°μ‚¬ = cp_model.CpSolver()
ν•΄κ²°μ‚¬.parameters.max_time_in_seconds = 60.0

μ‹μ‘_μ‹κ°„_μ΄ = time.time()
μƒνƒ = ν•΄κ²°μ‚¬.Solve(λ¨λΈ)
μΆ…λ£_μ‹κ°„_μ΄ = time.time()

# --- 5. κ²°κ³Ό μ¶λ ¥ ---
print("\n" + "="*70)
print(f"ν•΄μ°ΎκΈ° μ†μ” μ‹κ°„: {μΆ…λ£_μ‹κ°„_μ΄ - μ‹μ‘_μ‹κ°„_μ΄:.2f} μ΄")
print("="*70)

if μƒνƒ == cp_model.OPTIMAL or μƒνƒ == cp_model.FEASIBLE:
    print("β… μµμ  λλ” μ‹¤ν„ κ°€λ¥ν• μ‹κ°„ν‘λ¥Ό μ°Ύμ•μµλ‹λ‹¤!")

    μµμΆ…_μ‹κ°„ν‘ = []
    for κ°•μ in κ°•μ_λ©λ΅:
        κ°•μID = κ°•μ['κ°•μID']
        μ‹μ‘_κ°’ = ν•΄κ²°μ‚¬.Value(λ°°μ •_λ³€μ[κ°•μID][0])
        κ°•μμ‹¤_μΈλ±μ¤ = ν•΄κ²°μ‚¬.Value(λ°°μ •_λ³€μ[κ°•μID][1])
        μ”μΌ_μΈλ±μ¤ = μ‹μ‘_κ°’ // μΌλ³„_μ‹κ°„_μ
        μ‹κ°„_μ‹μ‘_μΈλ±μ¤ = μ‹μ‘_κ°’ % μΌλ³„_μ‹κ°„_μ
        μµμΆ…_μ‹κ°„ν‘.append({
            'κµκ³Όλ©λ…': κ°•μ['κµκ³Όλ©λ…'],
            'κµμλ…': κ°•μ['κµμλ…'],
            'κ°•μμ‹κ°„(μ¬λ΅―)': κ°•μ['κ°•μμ‹κ°„'],
            'μκ°•μΈμ›': κ°•μ['μκ°•μΈμ›'],
            'κ°•μμ‹¤': κ°•μμ‹¤_μ΄λ¦„_λ©λ΅[κ°•μμ‹¤_μΈλ±μ¤],
            'μ”μΌ_μΈλ±μ¤': μ”μΌ_μΈλ±μ¤,
            'μ‹κ°„_μ‹μ‘_μΈλ±μ¤': μ‹κ°„_μ‹μ‘_μΈλ±μ¤
        })

    μ‹κ°„ν‘_df = pd.DataFrame(μµμΆ…_μ‹κ°„ν‘)
    μ‹κ°„ν‘_df = μ‹κ°„ν‘_df.sort_values(by=['μ”μΌ_μΈλ±μ¤', 'μ‹κ°„_μ‹μ‘_μΈλ±μ¤', 'κ°•μμ‹¤'])
    μ”μΌ_μ΄λ¦„_λ©λ΅ = ['μ›”', 'ν™”', 'μ', 'λ©', 'κΈ']

    def μ‹κ°„_λ²”μ„_κ³„μ‚°(μ‹μ‘_μΈλ±μ¤, μ‹κ°„):
        μ‹μ‘_μ‹ = μ‹μ‘_μΈλ±μ¤ + 9
        μΆ…λ£_μ‹ = μ‹μ‘_μ‹ + μ‹κ°„
        return f'{μ‹μ‘_μ‹:02d}:00 - {μΆ…λ£_μ‹:02d}:00'

    μ‹κ°„ν‘_df['μ”μΌ'] = μ‹κ°„ν‘_df['μ”μΌ_μΈλ±μ¤'].apply(lambda x: μ”μΌ_μ΄λ¦„_λ©λ΅[x])
    μ‹κ°„ν‘_df['μ‹κ°„λ€'] = μ‹κ°„ν‘_df.apply(lambda row: μ‹κ°„_λ²”μ„_κ³„μ‚°(row['μ‹κ°„_μ‹μ‘_μΈλ±μ¤'], row['κ°•μμ‹κ°„(μ¬λ΅―)']), axis=1)

    print("\nπΆ μλ™ μƒμ„±λ μµμΆ… κ°•μ μ‹κ°„ν‘:\n")
    print(μ‹κ°„ν‘_df[['μ”μΌ', 'μ‹κ°„λ€', 'κ°•μμ‹¤', 'κµκ³Όλ©λ…', 'κµμλ…', 'μκ°•μΈμ›', 'κ°•μμ‹κ°„(μ¬λ΅―)']].to_string(index=False))

else:
    print("β μ‹κ°„ν‘λ¥Ό μƒμ„±ν•  μ μ—†μµλ‹λ‹¤. μ μ•½ μ΅°κ±΄μ„ ν™•μΈν•μ„Έμ”.")
